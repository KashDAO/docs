---
title: 'PostMessage API'
description: 'Communicate between your page and Kash embeds using the PostMessage API'
---

# PostMessage API

Enable two-way communication between your webpage and embedded Kash threads using the browser's PostMessage API. This allows you to respond to embed events and programmatically control embed behavior.

---

## Overview

The PostMessage API enables:
- **Receiving events** from the embed (trades, market clicks, height changes)
- **Sending commands** to the embed (change theme, filter markets, scroll to market)
- **Tracking user interactions** for analytics
- **Dynamic UI updates** based on embed state

---

## Listening to Embed Events

### Basic Event Listener

Set up a listener to receive messages from the embed:

```javascript
window.addEventListener('message', (event) => {
  // Security: Verify origin
  if (event.origin !== 'https://app.kash.bot') {
    return;
  }

  console.log('Received from embed:', event.data);
});
```

<Warning>
**Security:** Always verify `event.origin` to prevent malicious messages from untrusted sources.
</Warning>

---

## Event Types

### 1. Embed Ready

Fired when the embed finishes loading:

```javascript
{
  type: 'embed_ready',
  threadId: 'abc123',
  marketCount: 12,
  timestamp: 1704067200000
}
```

**Example usage:**

```javascript
window.addEventListener('message', (event) => {
  if (event.origin !== 'https://app.kash.bot') return;

  if (event.data.type === 'embed_ready') {
    console.log(`Embed loaded with ${event.data.marketCount} markets`);
    // Optionally send initial configuration
    sendToEmbed({ type: 'set_theme', theme: 'dark' });
  }
});
```

### 2. Height Change

Fired when embed content height changes:

```javascript
{
  type: 'resize',
  height: 650,
  reason: 'content_loaded' // or 'market_expanded', 'filters_applied'
}
```

**Example usage - Dynamic height adjustment:**

```javascript
const iframe = document.getElementById('kash-embed');

window.addEventListener('message', (event) => {
  if (event.origin !== 'https://app.kash.bot') return;

  if (event.data.type === 'resize') {
    iframe.style.height = `${event.data.height}px`;
  }
});
```

### 3. Market Click

Fired when user clicks on a market:

```javascript
{
  type: 'market_click',
  marketId: 'market-456',
  marketTitle: 'Will Biden win the nomination?',
  currentProbability: 0.72,
  timestamp: 1704067200000
}
```

**Example usage - Track analytics:**

```javascript
window.addEventListener('message', (event) => {
  if (event.origin !== 'https://app.kash.bot') return;

  if (event.data.type === 'market_click') {
    // Track with your analytics
    analytics.track('Market Clicked', {
      market_id: event.data.marketId,
      market_title: event.data.marketTitle,
      probability: event.data.currentProbability,
    });

    // Or call Kash tracking API
    fetch('https://app.kash.bot/api/embeds/interactions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        embed_id: embedId,
        thread_id: threadId,
        market_id: event.data.marketId,
        interaction_type: 'click',
      }),
    });
  }
});
```

### 4. Trade Executed

Fired when user completes a trade:

```javascript
{
  type: 'trade_executed',
  marketId: 'market-456',
  outcome: 'yes', // 'yes' or 'no'
  amount: 1000, // cents
  shares: 1389, // shares purchased
  newProbability: 0.73,
  timestamp: 1704067200000
}
```

**Example usage - Show confirmation:**

```javascript
window.addEventListener('message', (event) => {
  if (event.origin !== 'https://app.kash.bot') return;

  if (event.data.type === 'trade_executed') {
    showNotification(
      `Trade confirmed! You bought ${event.data.shares} ${event.data.outcome.toUpperCase()} shares for $${(event.data.amount / 100).toFixed(2)}`
    );
  }
});
```

### 5. Market Expanded

Fired when user expands market details:

```javascript
{
  type: 'market_expanded',
  marketId: 'market-456',
  expanded: true // or false when collapsed
}
```

### 6. Filter Applied

Fired when user changes filters:

```javascript
{
  type: 'filter_applied',
  filters: {
    status: 'active',
    sortBy: 'total_volume',
    sortOrder: 'desc'
  },
  resultCount: 8
}
```

### 7. Navigation

Fired when user navigates within embed:

```javascript
{
  type: 'navigation',
  action: 'view_all_markets', // or 'open_market_detail', 'close_modal'
  marketId: 'market-456' // optional
}
```

---

## Sending Commands to Embed

### Basic Command Sending

Send messages to the embed iframe:

```javascript
function sendToEmbed(message) {
  const iframe = document.getElementById('kash-embed');
  iframe.contentWindow.postMessage(message, 'https://app.kash.bot');
}
```

---

## Command Types

### 1. Set Theme

Change embed theme dynamically:

```javascript
sendToEmbed({
  type: 'set_theme',
  theme: 'dark', // 'light' or 'dark'
});
```

**Example - Theme toggle button:**

```html
<button onclick="toggleEmbedTheme()">Toggle Theme</button>

<script>
  let currentTheme = 'light';

  function toggleEmbedTheme() {
    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
    sendToEmbed({
      type: 'set_theme',
      theme: currentTheme,
    });
  }
</script>
```

### 2. Apply Filters

Programmatically filter markets:

```javascript
sendToEmbed({
  type: 'apply_filters',
  filters: {
    status: 'active',
    sortBy: 'total_volume',
    sortOrder: 'desc',
    limit: 10,
  },
});
```

**Example - Filter buttons:**

```html
<button onclick="showActiveMarkets()">Active</button>
<button onclick="showResolvedMarkets()">Resolved</button>
<button onclick="showTopVolume()">Top Volume</button>

<script>
  function showActiveMarkets() {
    sendToEmbed({
      type: 'apply_filters',
      filters: { status: 'active' },
    });
  }

  function showResolvedMarkets() {
    sendToEmbed({
      type: 'apply_filters',
      filters: { status: 'resolved' },
    });
  }

  function showTopVolume() {
    sendToEmbed({
      type: 'apply_filters',
      filters: { sortBy: 'total_volume', sortOrder: 'desc', limit: 5 },
    });
  }
</script>
```

### 3. Scroll to Market

Scroll embed to specific market:

```javascript
sendToEmbed({
  type: 'scroll_to_market',
  marketId: 'market-456',
  behavior: 'smooth', // 'smooth' or 'instant'
});
```

### 4. Expand/Collapse Market

Open or close market details:

```javascript
sendToEmbed({
  type: 'toggle_market',
  marketId: 'market-456',
  expanded: true, // or false
});
```

### 5. Refresh Data

Force embed to refresh market data:

```javascript
sendToEmbed({
  type: 'refresh',
});
```

---

## Complete Integration Example

### Full Parent Page Implementation

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kash Embed with PostMessage</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      cursor: pointer;
    }

    button:hover {
      background: #f0f0f0;
    }

    .status {
      margin: 10px 0;
      padding: 10px;
      background: #f9fafb;
      border-radius: 4px;
      font-size: 14px;
    }

    #kash-embed {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>2024 Election Markets</h1>

  <div class="controls">
    <button onclick="toggleTheme()">Toggle Theme</button>
    <button onclick="showActive()">Active Only</button>
    <button onclick="showTopVolume()">Top Volume</button>
    <button onclick="refreshEmbed()">Refresh</button>
  </div>

  <div class="status" id="status">Loading embed...</div>

  <iframe
    id="kash-embed"
    src="https://app.kash.bot/threads/abc123?embed=true"
    height="600"
  ></iframe>

  <script>
    const iframe = document.getElementById('kash-embed');
    const status = document.getElementById('status');
    let embedId = null;
    let currentTheme = 'light';

    // Send message to embed
    function sendToEmbed(message) {
      iframe.contentWindow.postMessage(message, 'https://app.kash.bot');
    }

    // Listen for embed events
    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://app.kash.bot') return;

      const { type, data } = event.data;

      switch (type) {
        case 'embed_ready':
          status.textContent = `Embed loaded with ${data.marketCount} markets`;
          embedId = data.embedId;
          trackEmbedLoad(data.threadId);
          break;

        case 'resize':
          iframe.style.height = `${data.height}px`;
          break;

        case 'market_click':
          status.textContent = `Clicked: ${data.marketTitle}`;
          trackInteraction(data.marketId, 'click');
          break;

        case 'trade_executed':
          status.textContent = `Trade: ${data.shares} ${data.outcome.toUpperCase()} shares for $${(data.amount / 100).toFixed(2)}`;
          trackInteraction(data.marketId, 'trade', {
            amount: data.amount,
            outcome: data.outcome,
          });
          break;

        case 'filter_applied':
          status.textContent = `Filters applied: ${data.resultCount} markets shown`;
          break;
      }
    });

    // Control functions
    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      sendToEmbed({ type: 'set_theme', theme: currentTheme });
    }

    function showActive() {
      sendToEmbed({
        type: 'apply_filters',
        filters: { status: 'active' },
      });
    }

    function showTopVolume() {
      sendToEmbed({
        type: 'apply_filters',
        filters: { sortBy: 'total_volume', sortOrder: 'desc', limit: 10 },
      });
    }

    function refreshEmbed() {
      sendToEmbed({ type: 'refresh' });
      status.textContent = 'Refreshing...';
    }

    // Tracking functions
    async function trackEmbedLoad(threadId) {
      const response = await fetch('https://app.kash.bot/api/embeds/track', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          thread_id: threadId,
          source: window.location.hostname,
          referrer: document.referrer,
          user_agent: navigator.userAgent,
        }),
      });
      const data = await response.json();
      embedId = data.embed_id;
    }

    async function trackInteraction(marketId, interactionType, metadata = {}) {
      await fetch('https://app.kash.bot/api/embeds/interactions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          embed_id: embedId,
          thread_id: 'abc123',
          market_id: marketId,
          interaction_type: interactionType,
          metadata,
        }),
      });
    }
  </script>
</body>
</html>
```

---

## React Integration Example

### Custom Hook for PostMessage

```typescript
import { useEffect, useState, useCallback, useRef } from 'react';

interface EmbedEvent {
  type: string;
  data: any;
}

interface UseKashEmbedOptions {
  threadId: string;
  onReady?: (data: any) => void;
  onMarketClick?: (data: any) => void;
  onTradeExecuted?: (data: any) => void;
  onResize?: (height: number) => void;
}

export function useKashEmbed(options: UseKashEmbedOptions) {
  const iframeRef = useRef<HTMLIFrameElement>(null);
  const [isReady, setIsReady] = useState(false);
  const [height, setHeight] = useState(600);

  // Listen for messages
  useEffect(() => {
    function handleMessage(event: MessageEvent) {
      if (event.origin !== 'https://app.kash.bot') return;

      const { type, data } = event.data as EmbedEvent;

      switch (type) {
        case 'embed_ready':
          setIsReady(true);
          options.onReady?.(data);
          break;

        case 'resize':
          setHeight(data.height);
          options.onResize?.(data.height);
          break;

        case 'market_click':
          options.onMarketClick?.(data);
          break;

        case 'trade_executed':
          options.onTradeExecuted?.(data);
          break;
      }
    }

    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, [options]);

  // Send command to embed
  const sendCommand = useCallback((command: any) => {
    if (!iframeRef.current?.contentWindow) return;

    iframeRef.current.contentWindow.postMessage(
      command,
      'https://app.kash.bot'
    );
  }, []);

  return {
    iframeRef,
    isReady,
    height,
    sendCommand,
  };
}
```

### Using the Hook

```typescript
function EmbedWidget({ threadId }: { threadId: string }) {
  const [theme, setTheme] = useState<'light' | 'dark'>('light');

  const { iframeRef, isReady, height, sendCommand } = useKashEmbed({
    threadId,
    onReady: (data) => {
      console.log(`Embed ready with ${data.marketCount} markets`);
    },
    onMarketClick: (data) => {
      console.log(`Market clicked: ${data.marketTitle}`);
    },
    onTradeExecuted: (data) => {
      alert(`Trade executed: ${data.shares} shares for $${data.amount / 100}`);
    },
  });

  function toggleTheme() {
    const newTheme = theme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
    sendCommand({ type: 'set_theme', theme: newTheme });
  }

  return (
    <div>
      <button onClick={toggleTheme} disabled={!isReady}>
        Toggle Theme
      </button>

      <iframe
        ref={iframeRef}
        src={`https://app.kash.bot/threads/${threadId}?embed=true`}
        width="100%"
        height={height}
        style={{ border: 0 }}
      />
    </div>
  );
}
```

---

## Security Best Practices

### 1. Always Validate Origin

```javascript
window.addEventListener('message', (event) => {
  // REQUIRED: Verify origin
  if (event.origin !== 'https://app.kash.bot') {
    console.warn('Ignoring message from unknown origin:', event.origin);
    return;
  }

  // Process message
});
```

### 2. Validate Message Structure

```javascript
function isValidEmbedEvent(data: any): boolean {
  return (
    data &&
    typeof data === 'object' &&
    typeof data.type === 'string' &&
    data.type.startsWith('embed_')
  );
}

window.addEventListener('message', (event) => {
  if (event.origin !== 'https://app.kash.bot') return;

  if (!isValidEmbedEvent(event.data)) {
    console.warn('Invalid message format:', event.data);
    return;
  }

  // Process valid message
});
```

### 3. Sanitize User Input

```javascript
function sendFilterCommand(userInput: string) {
  // Sanitize before sending
  const sanitized = userInput.replace(/[<>]/g, '');

  sendToEmbed({
    type: 'apply_filters',
    filters: { search: sanitized },
  });
}
```

---

## Debugging

### Log All Events

```javascript
window.addEventListener('message', (event) => {
  if (event.origin !== 'https://app.kash.bot') return;

  console.group('Kash Embed Event');
  console.log('Type:', event.data.type);
  console.log('Data:', event.data);
  console.log('Timestamp:', new Date().toISOString());
  console.groupEnd();
});
```

### Test Command Sending

```javascript
// Add to browser console for testing
function testCommand(type, data = {}) {
  const iframe = document.getElementById('kash-embed');
  iframe.contentWindow.postMessage({ type, ...data }, 'https://app.kash.bot');
  console.log('Sent command:', { type, ...data });
}

// Usage in console:
// testCommand('set_theme', { theme: 'dark' })
// testCommand('apply_filters', { filters: { status: 'active' } })
```

---

## Next Steps

<CardGroup cols={2}>
  <Card title="Thread Iframe Guide" href="/developer-docs/public-embed-api/guides/thread-iframe">
    Learn basic iframe embedding
  </Card>
  <Card title="React Examples" href="/developer-docs/public-embed-api/examples/react">
    Complete React component examples
  </Card>
  <Card title="Embed Tracking" href="/developer-docs/public-embed-api/endpoints/embed-tracking">
    Track embed usage with API
  </Card>
  <Card title="Customization" href="/developer-docs/public-embed-api/guides/customization">
    Styling and theming options
  </Card>
</CardGroup>
